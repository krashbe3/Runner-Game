<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Krashcore Dino Runner</title>
<style>
  body {
    margin: 0; background: #001f2f; color: #00ffff; font-family: 'Courier New', monospace; overflow: hidden;
    display: flex; justify-content: center; align-items: center; height: 100vh;
    flex-direction: column;
  }
  #start-screen, #game-screen {
    width: 100vw; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;
  }
  #start-screen {
    padding: 30px;
    text-align: center;
  }
  button {
    margin-top: 30px;
    background: #00ffff;
    color: #001f2f;
    font-weight: bold;
    font-size: 1.2rem;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 0 10px #00ffff;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #00cccc;
  }
  canvas {
    display: none;
    background: #001f2f;
    box-shadow: 0 0 30px #00ffff;
    border-radius: 10px;
  }
</style>
</head>
<body>
  <div id="start-screen">
    <h1>Krashcore Dino Runner</h1>
    <p>Contrôles :</p>
    <ul style="text-align: left; max-width: 400px; margin: 0 auto;">
      <li>Flèche Haut : Sauter</li>
      <li>Flèche Bas : Glisser (se baisser)</li>
    </ul>
    <p>Évitez les obstacles au sol, au milieu et en hauteur.<br>Survivez le plus longtemps possible et faites le meilleur score !</p>
    <button id="start-btn">Continuer</button>
  </div>
  <div id="game-screen">
    <canvas id="game-canvas" width="800" height="300"></canvas>
  </div>

<script>
(() => {
  const canvas = document.getElementById('game-canvas');
  const ctx = canvas.getContext('2d');

  const WIDTH = canvas.width;
  const HEIGHT = canvas.height;

  const player = {
    x: 50,
    y: HEIGHT - 130,
    width: 40,
    height: 60,
    vy: 0,
    jumping: false,
    sliding: false,
    slideTimer: 0,
    frameIndex: 0,
    frameCount: 0,
    currentAnim: 'run'
  };

  // Obstacle class
  class Obstacle {
    constructor(type) {
      this.type = type;
      // Définir taille et position selon type
      if (type === 'low') {
        this.width = 20;
        this.height = 40;
        this.y = HEIGHT - 50 - this.height; // au sol
      } else if (type === 'mid') {
        this.width = 30;
        this.height = 50;
        this.y = HEIGHT - 130; // milieu, à la hauteur du joueur debout (donc à sauter)
      } else if (type === 'high') {
        this.width = 40;
        this.height = 40;
        this.y = HEIGHT - 200; // en haut, obstacle à esquiver en se baissant
      }
      this.x = WIDTH + 20;
      this.speed = gameSpeed;
    }
    update() {
      this.x -= this.speed;
    }
    draw() {
      ctx.fillStyle = '#ff0044';
      ctx.shadowColor = '#ff0044';
      ctx.shadowBlur = 10;
      ctx.fillRect(this.x, this.y, this.width, this.height);
    }
  }

  let obstacles = [];
  let gameSpeed = 6;
  let score = 0;
  let highScore = 0;
  let gameOver = false;

  let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  function playSound(frequency, duration=0.1) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = frequency;
    osc.start();
    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    osc.stop(audioCtx.currentTime + duration);
  }

  function startMusic() {
    playSound(200, 0.05);
    setTimeout(() => {
      if(!gameOver) startMusic();
    }, 400);
  }

  const animFrames = {
    run: [
      [0,0],[40,0],[80,0],[120,0]
    ],
    jump: [
      [0,60],[40,60],[80,60],[120,60]
    ],
    slide: [
      [0,120],[40,120],[80,120]
    ],
    dead: [
      [0,180]
    ]
  };

  function drawPlayerFrame(x, y, frameIndex, anim) {
    ctx.fillStyle = '#00ffff';
    ctx.shadowColor = '#00ffff';
    ctx.shadowBlur = 10;
    ctx.lineWidth = 2;

    ctx.clearRect(x - 1, y - 1, player.width + 2, player.height + 2);

    ctx.strokeStyle = '#00ffff';

    ctx.strokeRect(x, y, player.width, player.height);

    ctx.beginPath();
    let offset = (frameIndex % 4) * 3;
    for(let i=0; i<player.height; i+=8) {
      ctx.moveTo(x + offset, y + i);
      ctx.lineTo(x + offset + 5, y + i + 4);
    }
    ctx.stroke();

    ctx.fillStyle = anim === 'dead' ? '#ff0044' : '#00ffff';
    ctx.fillRect(x + 10, y + 10, 6, 6);
  }

  const gravity = 1.2;
  const jumpForce = 18;

  let obstacleTimer = 0;
  let obstacleInterval = 100;

  function update() {
    if(gameOver) return;

    if(player.jumping) {
      player.vy -= gravity;
      player.y -= player.vy;
      if(player.y >= HEIGHT - 130) {
        player.y = HEIGHT - 130;
        player.jumping = false;
        player.vy = 0;
        player.currentAnim = 'run';
      }
    }
    if(player.sliding) {
      player.slideTimer--;
      if(player.slideTimer <= 0) {
        player.sliding = false;
        player.currentAnim = 'run';
        player.height = 60;
        player.y = HEIGHT - 130;
      }
    }

    obstacleTimer++;
    if(obstacleTimer > obstacleInterval) {
      obstacleTimer = 0;
      // Proba pondérée pour équilibrer les obstacles
      const r = Math.random();
      let t;
      if(r < 0.4) t = 'low';       // 40% obstacles au sol
      else if(r < 0.75) t = 'high';// 35% obstacles en haut
      else t = 'mid';              // 25% obstacles milieu
      obstacles.push(new Obstacle(t));

      if(obstacleInterval > 30) obstacleInterval -= 0.7; // baisse plus rapide
      gameSpeed += 0.02;  // accélération plus forte
    }

    obstacles.forEach((obs, i) => {
      obs.speed = gameSpeed;
      obs.update();

      let px = player.x;
      let py = player.y;
      let pw = player.width;
      let ph = player.height;
      let ox = obs.x;
      let oy = obs.y;
      let ow = obs.width;
      let oh = obs.height;

      if(px < ox + ow &&
         px + pw > ox &&
         py < oy + oh &&
         py + ph > oy) {
        gameOver = true;
        if(score > highScore) highScore = score;
        playSound(100, 0.5);
      }

      if(obs.x + obs.width < 0) {
        obstacles.splice(i,1);
        score++;  // +1 point par obstacle passé
        playSound(300, 0.05);
      }
    });

    player.frameCount++;
    if(player.frameCount % 5 === 0) {
      player.frameIndex++;
      if(player.currentAnim === 'run' && player.frameIndex >= animFrames.run.length) player.frameIndex = 0;
      if(player.currentAnim === 'jump' && player.frameIndex >= animFrames.jump.length) player.frameIndex = animFrames.jump.length - 1;
      if(player.currentAnim === 'slide' && player.frameIndex >= animFrames.slide.length) player.frameIndex = 0;
    }
  }

  function draw() {
    ctx.clearRect(0,0,WIDTH,HEIGHT);

    ctx.strokeStyle = '#00ffff';
    ctx.lineWidth = 2;
    ctx.shadowColor = '#00ffff';
    ctx.shadowBlur = 5;
    ctx.beginPath();
    ctx.moveTo(0, HEIGHT - 50);
    ctx.lineTo(WIDTH, HEIGHT - 50);
    ctx.stroke();

    obstacles.forEach(obs => obs.draw());

    drawPlayerFrame(player.x, player.y, player.frameIndex, player.currentAnim);

    ctx.fillStyle = '#00ffff';
    ctx.font = 'bold 24px monospace';
    ctx.shadowColor = '#00ffff';
    ctx.shadowBlur = 10;
    ctx.fillText(`Score: ${score}`, 20, 40);

    if(gameOver) {
      ctx.fillStyle = '#ff0044';
      ctx.font = 'bold 48px monospace';
      ctx.fillText('Game Over!', WIDTH / 2 - 130, HEIGHT / 2);
      ctx.font = '24px monospace';
      ctx.fillText(`High Score: ${highScore}`, WIDTH / 2 - 110, HEIGHT / 2 + 40);
      ctx.fillText('Refresh page to restart', WIDTH / 2 - 130, HEIGHT / 2 + 80);
    }
  }

  function loop() {
    update();
    draw();
    if(!gameOver) requestAnimationFrame(loop);
  }

  window.addEventListener('keydown', (e) => {
    if(gameOver) return;
    if(e.key === 'ArrowUp' && !player.jumping && !player.sliding) {
      player.vy = jumpForce;
      player.jumping = true;
      player.currentAnim = 'jump';
      playSound(600, 0.1);
    }
    if(e.key === 'ArrowDown' && !player.jumping && !player.sliding) {
      player.sliding = true;
      player.slideTimer = 20;
      player.currentAnim = 'slide';
      player.height = 30;
      player.y = HEIGHT - 100;
      playSound(400, 0.1);
    }
  });

  function startGame() {
    obstacles = [];
    gameSpeed = 6;
    score = 0;
    gameOver = false;
    player.y = HEIGHT - 130;
    player.vy = 
